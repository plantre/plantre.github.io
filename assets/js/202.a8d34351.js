(window.webpackJsonp=window.webpackJsonp||[]).push([[202],{559:function(a,s,t){"use strict";t.r(s);var r=t(7),e=Object(r.a)({},(function(){var a=this,s=a._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("h1",{attrs:{id:"启用路由转发"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#启用路由转发"}},[a._v("#")]),a._v(" 启用路由转发")]),a._v(" "),s("p",[a._v("echo 1 > /proc/sys/net/ipv4/ip_forward")]),a._v(" "),s("h1",{attrs:{id:"dnat-把目标为-b-的请求转发给-c"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#dnat-把目标为-b-的请求转发给-c"}},[a._v("#")]),a._v(" DNAT 把目标为 B 的请求转发给 C")]),a._v(" "),s("p",[a._v("iptables -t nat -A PREROUTING -d 1.2.3.4 -j DNAT --to-destination 5.6.7.8")]),a._v(" "),s("h1",{attrs:{id:"snat-修改源地址为-a-自己-避免-c-无法返回"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#snat-修改源地址为-a-自己-避免-c-无法返回"}},[a._v("#")]),a._v(" SNAT 修改源地址为 A 自己，避免 C 无法返回")]),a._v(" "),s("p",[a._v("iptables -t nat -A POSTROUTING -j MASQUERADE， 以具体的ip数据包说明")]),a._v(" "),s("p",[a._v("好的，我们通过一个具体的 "),s("strong",[a._v("IP 数据包流程示例")]),a._v("，详细说明你配置的 "),s("code",[a._v("iptables")]),a._v(" 规则如何让客户端 A 将原本发给服务器 B 的数据，"),s("strong",[a._v("透明地转发到服务器 C 并收到响应")]),a._v("。")]),a._v(" "),s("hr"),a._v(" "),s("h2",{attrs:{id:"📦-场景设定"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#📦-场景设定"}},[a._v("#")]),a._v(" 📦 场景设定：")]),a._v(" "),s("ul",[s("li",[a._v("你现在配置在主机 A 上作为网关或跳板机。")]),a._v(" "),s("li",[a._v("某台客户端（例如 A 本人或 A 后面的机器）原本要访问：")])]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("目的 IP（B）：1.2.3.4 （已宕机）\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("ul",[s("li",[a._v("你希望它实际上访问：")])]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("真实处理服务器 C 的 IP：5.6.7.8\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("hr"),a._v(" "),s("h2",{attrs:{id:"✅-配置回顾-iptables-转发规则"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#✅-配置回顾-iptables-转发规则"}},[a._v("#")]),a._v(" ✅ 配置回顾（iptables 转发规则）：")]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 启用 IP 转发")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" /proc/sys/net/ipv4/ip_forward\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 把发往 1.2.3.4 的数据包转发给 5.6.7.8")]),a._v("\niptables "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-t")]),a._v(" nat "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-A")]),a._v(" PREROUTING "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1.2")]),a._v(".3.4 "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-j")]),a._v(" DNAT --to-destination "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("5.6")]),a._v(".7.8\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 把原始源 IP 伪装成 A 的 IP，保证返回能成功")]),a._v("\niptables "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-t")]),a._v(" nat "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-A")]),a._v(" POSTROUTING "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-j")]),a._v(" MASQUERADE\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br")])]),s("hr"),a._v(" "),s("h2",{attrs:{id:"🔄-数据包流动过程详解-按顺序"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#🔄-数据包流动过程详解-按顺序"}},[a._v("#")]),a._v(" 🔄 数据包流动过程详解（按顺序）：")]),a._v(" "),s("table",[s("thead",[s("tr",[s("th",[a._v("步骤")]),a._v(" "),s("th",[a._v("原始数据包内容")]),a._v(" "),s("th",[a._v("描述")])])]),a._v(" "),s("tbody",[s("tr",[s("td",[a._v("1️⃣ 客户端发出请求")]),a._v(" "),s("td",[a._v("源 IP：192.168.0.100"),s("br"),a._v("目标 IP：1.2.3.4")]),a._v(" "),s("td",[a._v("客户端认为它在访问服务器 B")])]),a._v(" "),s("tr",[s("td",[a._v("2️⃣ A 机器拦截到数据包（PREROUTING）")]),a._v(" "),s("td",[a._v("- 检测目标 IP 为 1.2.3.4"),s("br"),a._v("- 触发 "),s("code",[a._v("DNAT")]),a._v(" 规则"),s("br"),a._v("- 修改目标 IP 为 5.6.7.8")]),a._v(" "),s("td",[a._v("数据包现在变为："),s("br"),a._v("源 IP：192.168.0.100"),s("br"),a._v("目标 IP："),s("strong",[a._v("5.6.7.8")])])]),a._v(" "),s("tr",[s("td",[a._v("3️⃣ 数据包被转发到服务器 C")]),a._v(" "),s("td",[a._v("源 IP：192.168.0.100"),s("br"),a._v("目标 IP：5.6.7.8")]),a._v(" "),s("td",[a._v("C 收到请求，以为是客户端直接访问")])]),a._v(" "),s("tr",[s("td",[a._v("4️⃣ C 回复响应包")]),a._v(" "),s("td",[a._v("源 IP：5.6.7.8"),s("br"),a._v("目标 IP：192.168.0.100")]),a._v(" "),s("td",[a._v("C 发回响应，回到主机 A")])]),a._v(" "),s("tr",[s("td",[a._v("5️⃣ A 机器匹配 conntrack 连接跟踪（POSTROUTING）"),s("br"),a._v("触发 "),s("code",[a._v("MASQUERADE")])]),a._v(" "),s("td",[a._v("- A 修改响应数据包源地址"),s("br"),a._v("- 把源 IP 变成 1.2.3.4"),s("br"),a._v("（或 A 的 IP）")]),a._v(" "),s("td",[a._v("客户端收到响应时，看不出是 C 回复的")])]),a._v(" "),s("tr",[s("td",[a._v("6️⃣ 客户端收到响应")]),a._v(" "),s("td",[a._v("源 IP：1.2.3.4"),s("br"),a._v("目标 IP：192.168.0.100")]),a._v(" "),s("td",[a._v("客户端以为自己与服务器 B 正常通信了")])])])]),a._v(" "),s("hr"),a._v(" "),s("h2",{attrs:{id:"✅-结果"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#✅-结果"}},[a._v("#")]),a._v(" ✅ 结果")]),a._v(" "),s("p",[a._v("客户端以为它与 "),s("code",[a._v("1.2.3.4")]),a._v("（B）建立了通信，但其实：")]),a._v(" "),s("ul",[s("li",[a._v("所有请求都被 A 主机偷偷转发到了 C（5.6.7.8）")]),a._v(" "),s("li",[a._v("所有响应也由 A 修改返回路径，伪装成 B")])]),a._v(" "),s("hr"),a._v(" "),s("h2",{attrs:{id:"📌-关键点解释"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#📌-关键点解释"}},[a._v("#")]),a._v(" 📌 关键点解释：")]),a._v(" "),s("ul",[s("li",[s("strong",[a._v("DNAT（目的地址转换）")]),a._v("：修改目标地址，把包发给新的服务。")]),a._v(" "),s("li",[s("strong",[a._v("SNAT/MASQUERADE（源地址转换）")]),a._v("：让返回路径正确，C 不直接返回给客户端，而是通过 A。")]),a._v(" "),s("li",[s("strong",[a._v("ip_forward=1")]),a._v("：Linux 允许转发数据包，A 相当于一个透明路由器。")])]),a._v(" "),s("hr"),a._v(" "),s("h2",{attrs:{id:"💡-举例封包-tcp-层"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#💡-举例封包-tcp-层"}},[a._v("#")]),a._v(" 💡 举例封包（TCP 层）")]),a._v(" "),s("p",[a._v("请求包：")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("Client -> A（PREROUTING）: SYN packet\nSrc: 192.168.0.100\nDst: 1.2.3.4 → DNAT → 5.6.7.8\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br")])]),s("p",[a._v("C 收到包后返回：")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("C → A（POSTROUTING）→ Client\nSrc: 5.6.7.8 → MASQUERADE → 1.2.3.4\nDst: 192.168.0.100\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br")])]),s("hr"),a._v(" "),s("p",[a._v("如你希望我提供一个 "),s("strong",[a._v("完整可执行的 Shell 脚本示例（含防火墙清除、规则设置等）")]),a._v("，我也可以补充。需要吗？")])])}),[],!1,null,null,null);s.default=e.exports}}]);