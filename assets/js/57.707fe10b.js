(window.webpackJsonp=window.webpackJsonp||[]).push([[57],{414:function(s,a,t){"use strict";t.r(a);var e=t(7),n=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("p",[s._v("关于 "),a("code",[s._v("FOR UPDATE")]),s._v(" 的验证与分析")]),s._v(" "),a("p",[s._v("在 MySQL 中，"),a("code",[s._v("SELECT ... FOR UPDATE")]),s._v(" 是一种悲观锁机制，用于在事务中锁定目标数据行或表，防止其他事务修改。其锁类型（行锁或表锁）及行为取决于查询条件、索引使用和事务隔离级别。以下是关键验证结论及操作方法：")]),s._v(" "),a("hr"),s._v(" "),a("p",[s._v("一、验证锁类型的关键条件")]),s._v(" "),a("ol",[a("li",[a("p",[s._v("主键或唯一索引"),a("br"),s._v("\n• 条件：查询条件包含主键或唯一索引字段（如 "),a("code",[s._v("id=1")]),s._v(" 或 "),a("code",[s._v("account_no='0001'")]),s._v("）。")]),s._v(" "),a("p",[s._v("• 行为：仅锁定符合条件的行（行锁），其他行的操作不受影响。")]),s._v(" "),a("p",[s._v("• 验证步骤：")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 事务1：锁定主键为1的行")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("BEGIN")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("user")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" id "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FOR")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("UPDATE")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 事务2：尝试更新同一行（阻塞）")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("UPDATE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("user")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SET")]),s._v(" age "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" id "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 事务3：更新其他行（成功）")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("UPDATE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("user")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SET")]),s._v(" age "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" id "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("普通索引或范围查询"),a("br"),s._v("\n• 条件：查询条件为普通索引字段（如 "),a("code",[s._v("user_name='user01'")]),s._v("）或范围（如 "),a("code",[s._v("id IN (1,2)")]),s._v("）。")]),s._v(" "),a("p",[s._v("• 行为：行锁 + 间隙锁（Gap Lock），防止其他事务插入符合条件的新数据（避免幻读）。")]),s._v(" "),a("p",[s._v("• 验证步骤：")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 事务1：锁定普通索引字段")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("BEGIN")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("user")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" user_name "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'user01'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FOR")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("UPDATE")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 事务2：尝试插入相同索引值的记录（阻塞）")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INSERT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INTO")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("user")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("user_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("VALUES")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'user01'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("无索引的普通字段"),a("br"),s._v("\n• 条件：查询条件为无索引字段（如 "),a("code",[s._v("code='0001'")]),s._v("）。")]),s._v(" "),a("p",[s._v("• 行为：锁定整张表（表锁），所有更新操作均阻塞。")]),s._v(" "),a("p",[s._v("• 验证步骤：")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 事务1：锁定无索引字段")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("BEGIN")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("user")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" code "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'0001'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FOR")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("UPDATE")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 事务2：更新任意行（均阻塞）")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("UPDATE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("user")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SET")]),s._v(" code "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'0002'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" id "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])])])]),s._v(" "),a("hr"),s._v(" "),a("p",[s._v("二、锁类型的判断方法")]),s._v(" "),a("ol",[a("li",[a("p",[s._v("观察阻塞行为"),a("br"),s._v("\n• 若其他事务更新同一行数据被阻塞，则为行锁。")]),s._v(" "),a("p",[s._v("• 若更新其他行数据也被阻塞，则为表锁。")])]),s._v(" "),a("li",[a("p",[s._v("查看锁信息"),a("br"),s._v("\n执行以下 SQL 查询当前锁状态（需在事务阻塞时执行）：")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" INFORMATION_SCHEMA"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("INNODB_LOCKS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("• 行锁："),a("code",[s._v("lock_type")]),s._v(" 为 "),a("code",[s._v("RECORD")]),s._v("，"),a("code",[s._v("lock_data")]),s._v(" 显示锁定行的主键值。")]),s._v(" "),a("p",[s._v("• 表锁："),a("code",[s._v("lock_type")]),s._v(" 为 "),a("code",[s._v("TABLE")]),s._v("，且无具体行信息。")])])]),s._v(" "),a("hr"),s._v(" "),a("p",[s._v("三、事务隔离级别的影响")]),s._v(" "),a("ol",[a("li",[a("p",[s._v("可重复读（RR）"),a("br"),s._v("\n• 默认行为：InnoDB 默认隔离级别，使用行锁 + 间隙锁。")]),s._v(" "),a("p",[s._v("• 验证场景：普通索引查询会锁定间隙，防止插入新数据（幻读）。")])]),s._v(" "),a("li",[a("p",[s._v("读已提交（RC）"),a("br"),s._v("\n• 行为：仅锁定现有行，不锁定间隙，可能允许幻读。")]),s._v(" "),a("p",[s._v("• 验证场景：在 RC 级别下，普通索引查询不会阻塞插入操作。")])])]),s._v(" "),a("hr"),s._v(" "),a("p",[s._v("四、注意事项")]),s._v(" "),a("ol",[a("li",[a("p",[s._v("性能与死锁"),a("br"),s._v("\n• 锁范围最小化：尽量通过主键或索引缩小锁定范围，减少锁冲突。")]),s._v(" "),a("p",[s._v("• 超时设置：通过 "),a("code",[s._v("innodb_lock_wait_timeout")]),s._v(" 设置锁等待超时时间（默认 50 秒）。")]),s._v(" "),a("p",[s._v("• 死锁检测：MySQL 自动检测死锁并回滚事务，但需优化事务执行顺序。")])]),s._v(" "),a("li",[a("p",[s._v("事务提交与回滚"),a("br"),s._v("\n• 锁释放时机：事务提交（"),a("code",[s._v("COMMIT")]),s._v("）或回滚（"),a("code",[s._v("ROLLBACK")]),s._v("）后释放锁。")]),s._v(" "),a("p",[s._v("• 自动提交模式：关闭自动提交（"),a("code",[s._v("SET autocommit=0")]),s._v("）以手动控制事务边界。")])])]),s._v(" "),a("hr"),s._v(" "),a("p",[s._v("五、适用场景")]),s._v(" "),a("ol",[a("li",[s._v("金融交易：转账时锁定账户行，防止并发修改导致金额错误。")]),s._v(" "),a("li",[s._v("库存管理：扣减库存时锁定商品行，避免超卖。")]),s._v(" "),a("li",[s._v("订单处理：更新订单状态时确保原子性操作。")])]),s._v(" "),a("hr"),s._v(" "),a("p",[s._v("验证步骤总结")]),s._v(" "),a("ol",[a("li",[s._v("环境准备：创建含主键、唯一索引、普通索引和无索引字段的表。")]),s._v(" "),a("li",[s._v("关闭自动提交："),a("code",[s._v("SET autocommit=0")]),s._v("。")]),s._v(" "),a("li",[s._v("多会话测试：通过多个数据库会话模拟并发操作，观察阻塞行为。")]),s._v(" "),a("li",[s._v("锁信息监控：结合 "),a("code",[s._v("INNODB_LOCKS")]),s._v(" 表分析锁类型。")])]),s._v(" "),a("p",[s._v("通过上述验证，可明确 "),a("code",[s._v("FOR UPDATE")]),s._v(" 的锁机制，从而合理设计高并发场景下的数据访问逻辑。")])])}),[],!1,null,null,null);a.default=n.exports}}]);