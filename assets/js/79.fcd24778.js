(window.webpackJsonp=window.webpackJsonp||[]).push([[79],{436:function(t,s,a){"use strict";a.r(s);var n=a(7),r=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("p",[t._v("在 Redis 3主3从集群中实现分布式锁时，需结合 Redis Cluster 的特性和分布式锁的核心原则（互斥性、容错性、避免死锁）设计。以下是具体方案及注意事项：")]),t._v(" "),s("hr"),t._v(" "),s("h3",{attrs:{id:"🔒-一、基础方案-单节点锁-适用于低要求场景"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#🔒-一、基础方案-单节点锁-适用于低要求场景"}},[t._v("#")]),t._v(" 🔒 一、基础方案：单节点锁（适用于低要求场景）")]),t._v(" "),s("h4",{attrs:{id:"实现步骤"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#实现步骤"}},[t._v("#")]),t._v(" "),s("strong",[t._v("实现步骤")])]),t._v(" "),s("ol",[s("li",[s("p",[s("strong",[t._v("加锁命令")]),s("br"),t._v("\n使用 "),s("code",[t._v("SET key unique_value NX PX 30000")]),t._v(" 命令：")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("NX")]),t._v("：仅当 Key 不存在时设置，保证互斥性。")]),t._v(" "),s("li",[s("code",[t._v("PX 30000")]),t._v("：设置 30 秒超时，避免死锁。")]),t._v(" "),s("li",[s("code",[t._v("unique_value")]),t._v("：使用 UUID 或线程 ID 标识锁持有者。")])])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("释放锁")]),s("br"),t._v("\n通过 Lua 脚本原子化释放（避免误删其他客户端的锁）：")]),t._v(" "),s("div",{staticClass:"language-lua line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-lua"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" redis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("call")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"GET"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" KEYS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" ARGV"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("then")]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" redis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("call")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"DEL"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" KEYS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" \n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" \n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br")])])])]),t._v(" "),s("h4",{attrs:{id:"风险"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#风险"}},[t._v("#")]),t._v(" "),s("strong",[t._v("风险")])]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("主从切换导致锁丢失")]),s("br"),t._v("\n主节点加锁后数据未同步到从节点时，若主节点宕机，从节点升级后无锁数据，导致其他客户端可重复加锁。")]),t._v(" "),s("li",[s("strong",[t._v("锁续期问题")]),s("br"),t._v("\n业务执行超时需手动续期（Watch Dog 机制），否则锁自动失效。")])]),t._v(" "),s("blockquote",[s("p",[s("strong",[t._v("适用场景")]),t._v("：对锁可靠性要求不高的业务（如缓存更新）。")])]),t._v(" "),s("hr"),t._v(" "),s("h3",{attrs:{id:"⚙️-二、高可用方案-redlock-算法-官方推荐"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#⚙️-二、高可用方案-redlock-算法-官方推荐"}},[t._v("#")]),t._v(" ⚙️ 二、高可用方案：RedLock 算法（官方推荐）")]),t._v(" "),s("p",[t._v("针对主从容错问题，Redis 作者提出 "),s("strong",[t._v("RedLock 算法")]),t._v("，通过多节点投票机制提升可靠性。")]),t._v(" "),s("h4",{attrs:{id:"实现流程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#实现流程"}},[t._v("#")]),t._v(" "),s("strong",[t._v("实现流程")])]),t._v(" "),s("ol",[s("li",[s("p",[s("strong",[t._v("部署独立节点")]),s("br"),t._v("\n3主3从集群中，将 "),s("strong",[t._v("3个主节点视为独立节点")]),t._v("（从节点仅用于备份，不参与锁决策）。")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("加锁步骤")]),t._v("：")]),t._v(" "),s("ol",[s("li",[t._v("生成全局唯一 ID（如 UUID）作为锁标识。")]),t._v(" "),s("li",[t._v("向所有主节点顺序发送加锁命令（"),s("code",[t._v("SET key uuid NX PX TTL")]),t._v("），并记录操作开始时间 "),s("code",[t._v("T1")]),t._v("。")]),t._v(" "),s("li",[t._v("计算总耗时 "),s("code",[t._v("T_total = T2 - T1")]),t._v("（"),s("code",[t._v("T2")]),t._v(" 为收到最后一个响应的时间），需满足：\n"),s("ul",[s("li",[s("code",[t._v("T_total < 锁超时时间")]),t._v("（防止锁自动失效）。")]),t._v(" "),s("li",[s("strong",[t._v("成功节点数 ≥ N/2 + 1")]),t._v("（3节点时需至少2个成功）。")])])]),t._v(" "),s("li",[t._v("若成功，锁实际有效时间 = "),s("code",[t._v("TTL - T_total - 时钟漂移补偿")]),t._v("。")])])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("释放锁")]),t._v("："),s("br"),t._v("\n向所有主节点发送 Lua 脚本释放锁（即使未成功加锁的节点也需尝试）。")])])]),t._v(" "),s("h4",{attrs:{id:"参数配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参数配置"}},[t._v("#")]),t._v(" "),s("strong",[t._v("参数配置")])]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[s("strong",[t._v("参数")])]),t._v(" "),s("th",[s("strong",[t._v("建议值")])]),t._v(" "),s("th",[s("strong",[t._v("说明")])])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("锁超时时间（TTL）")]),t._v(" "),s("td",[t._v("10s-30s")]),t._v(" "),s("td",[t._v("需大于业务最大耗时")])]),t._v(" "),s("tr",[s("td",[t._v("重试间隔")]),t._v(" "),s("td",[t._v("100-300ms")]),t._v(" "),s("td",[t._v("避免频繁重试压垮节点")])]),t._v(" "),s("tr",[s("td",[t._v("续期间隔")]),t._v(" "),s("td",[t._v("TTL/3（如10s）")]),t._v(" "),s("td",[t._v("Watch Dog 续期频率")])])])]),t._v(" "),s("h4",{attrs:{id:"生产级工具"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#生产级工具"}},[t._v("#")]),t._v(" "),s("strong",[t._v("生产级工具")])]),t._v(" "),s("p",[t._v("推荐使用 "),s("strong",[t._v("Redisson 库")]),t._v("（支持自动续期、可重入锁、RedLock 封装）：")]),t._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RedissonClient")]),t._v(" client "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Redisson")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("create")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RLock")]),t._v(" lock1 "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" client"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getLock")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"lock1"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RLock")]),t._v(" lock2 "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" client"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getLock")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"lock2"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RLock")]),t._v(" lock3 "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" client"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getLock")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"lock3"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RedissonRedLock")]),t._v(" redLock "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RedissonRedLock")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("lock1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" lock2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" lock3"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("redLock"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("tryLock")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("30")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TimeUnit")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("SECONDS")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 尝试5秒，锁有效期30秒")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 执行业务逻辑")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("finally")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    redLock"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("unlock")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br")])]),s("hr"),t._v(" "),s("h3",{attrs:{id:"⚠️-三、关键注意事项"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#⚠️-三、关键注意事项"}},[t._v("#")]),t._v(" ⚠️ 三、关键注意事项")]),t._v(" "),s("ol",[s("li",[s("p",[s("strong",[t._v("时钟同步问题")]),s("br"),t._v("\n节点间时钟漂移可能导致锁提前失效。建议通过 NTP 协议同步时间。")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("GC 停顿风险")]),s("br"),t._v("\n客户端长时间 GC 可能导致锁过期后误操作资源。需设置合理的 TTL 并监控 GC 时间。")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("节点故障恢复")]),s("br"),t._v("\n节点崩溃后若未持久化锁数据，恢复后可能与其他节点状态冲突。建议开启 AOF 持久化。")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("性能与可靠性权衡")])]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("单节点锁")]),t._v("：性能高，但可靠性低（仅用于非关键任务）。")]),t._v(" "),s("li",[s("strong",[t._v("RedLock")]),t._v("：可靠性高，但多节点通信增加延迟（适合金融等高要求场景）。")])])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("锁粒度控制")]),s("br"),t._v("\n锁 Key 需精确到业务资源（如 "),s("code",[t._v("order_123")]),t._v("），避免全局锁竞争。")])])]),t._v(" "),s("hr"),t._v(" "),s("h3",{attrs:{id:"💎-四、生产环境推荐方案"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#💎-四、生产环境推荐方案"}},[t._v("#")]),t._v(" 💎 四、生产环境推荐方案")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[s("strong",[t._v("场景")])]),t._v(" "),s("th",[s("strong",[t._v("方案")])]),t._v(" "),s("th",[s("strong",[t._v("工具")])])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("非关键任务（如缓存更新）")]),t._v(" "),s("td",[t._v("单节点锁 + Lua 释放")]),t._v(" "),s("td",[t._v("Spring Data Redis")])]),t._v(" "),s("tr",[s("td",[t._v("高并发业务（如订单支付）")]),t._v(" "),s("td",[t._v("RedLock 多节点投票")]),t._v(" "),s("td",[t._v("Redisson 库")])]),t._v(" "),s("tr",[s("td",[t._v("强一致性要求（如库存扣减）")]),t._v(" "),s("td",[t._v("结合数据库事务 + Redis 锁兜底")]),t._v(" "),s("td",[t._v("Seata + Redisson")])])])]),t._v(" "),s("blockquote",[s("p",[s("strong",[t._v("注")]),t._v("：Redis Cluster 的 3主3从架构中，RedLock 只需操作 3 个主节点（N=3），满足 "),s("strong",[t._v("N/2 + 1 = 2")]),t._v(" 的成功条件即可。")])]),t._v(" "),s("hr"),t._v(" "),s("h3",{attrs:{id:"📚-五、扩展阅读-redlock-的争议与替代"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#📚-五、扩展阅读-redlock-的争议与替代"}},[t._v("#")]),t._v(" 📚 五、扩展阅读：RedLock 的争议与替代")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("争议点")]),t._v("：极端场景下（如网络分区 + GC 停顿）仍可能锁失效。")]),t._v(" "),s("li",[s("strong",[t._v("替代方案")]),t._v("：\n"),s("ul",[s("li",[s("strong",[t._v("ZooKeeper 锁")]),t._v("：基于 ZAB 协议强一致，但性能低于 Redis。")]),t._v(" "),s("li",[s("strong",[t._v("etcd 锁")]),t._v("：基于 Raft 协议，适合对一致性要求极高的场景。")])])])]),t._v(" "),s("p",[t._v("建议根据业务容忍度选择方案：Redis 锁适用于 "),s("strong",[t._v("AP 系统")]),t._v("（高可用优先），ZK/etcd 适用于 "),s("strong",[t._v("CP 系统")]),t._v("（强一致优先）。")])])}),[],!1,null,null,null);s.default=r.exports}}]);