(window.webpackJsonp=window.webpackJsonp||[]).push([[203],{560:function(s,t,a){"use strict";a.r(t);var n=a(7),e=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("p",[s._v("是的，"),t("strong",[s._v("Nginx 可以在 A 主机上实现“将请求发送到服务器 B 的 IP 透明代理给服务器 C”")]),s._v("，不过请注意：")]),s._v(" "),t("blockquote",[t("p",[s._v("✅ "),t("strong",[s._v("前提：A 上的程序是主动使用 Nginx 发起请求")]),s._v("\n❌ "),t("strong",[s._v("Nginx 无法拦截“系统层面的任意出站 IP 包”")]),s._v(" —— 那个必须用 "),t("code",[s._v("iptables")]),s._v("、"),t("code",[s._v("ip rule")]),s._v(" 或 "),t("code",[s._v("TProxy")]),s._v("。")])]),s._v(" "),t("hr"),s._v(" "),t("h2",{attrs:{id:"✅-nginx-能做什么"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#✅-nginx-能做什么"}},[s._v("#")]),s._v(" ✅ Nginx 能做什么？")]),s._v(" "),t("p",[s._v("Nginx 是一个"),t("strong",[s._v("应用层（HTTP、TCP）反向代理服务器")]),s._v("，它只能处理明确发给它的请求，比如：")]),s._v(" "),t("ul",[t("li",[s._v("A 主机上运行的某个程序，请求 "),t("code",[s._v("http://1.2.3.4:80/")]),s._v(" 时，是"),t("strong",[s._v("通过 Nginx 转发")])]),s._v(" "),t("li",[s._v("或者 A 是网关，其他客户端显式请求 A 的 Nginx")])]),s._v(" "),t("hr"),s._v(" "),t("h2",{attrs:{id:"❌-nginx-不能做什么"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#❌-nginx-不能做什么"}},[s._v("#")]),s._v(" ❌ Nginx 不能做什么？")]),s._v(" "),t("p",[s._v("Nginx "),t("strong",[s._v("无法接管本机任意程序对某 IP 的直接连接请求")]),s._v("，比如：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" http://1.2.3.4/    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 这是直接 TCP 连接，Nginx 无法劫持")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("这种劫持只有 "),t("code",[s._v("iptables")]),s._v("、"),t("code",[s._v("TProxy")]),s._v("、或 "),t("code",[s._v("tun2socks")]),s._v(" 这类“系统级”组件能完成。")]),s._v(" "),t("hr"),s._v(" "),t("h2",{attrs:{id:"✅-nginx-使用场景举例-主动反代"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#✅-nginx-使用场景举例-主动反代"}},[s._v("#")]),s._v(" ✅ Nginx 使用场景举例（主动反代）")]),s._v(" "),t("p",[s._v("假设：")]),s._v(" "),t("ul",[t("li",[s._v("B 的 IP："),t("code",[s._v("1.2.3.4")]),s._v("（已宕机）")]),s._v(" "),t("li",[s._v("C 的 IP："),t("code",[s._v("5.6.7.8")]),s._v("（能用）")]),s._v(" "),t("li",[s._v("你希望 "),t("strong",[s._v("Nginx 监听 1.2.3.4:80 的请求")]),s._v("，转发给 C")])]),s._v(" "),t("p",[s._v("你可以：")]),s._v(" "),t("h3",{attrs:{id:"步骤-1-在-a-上绑定-b-的-ip-需要-root-权限"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#步骤-1-在-a-上绑定-b-的-ip-需要-root-权限"}},[s._v("#")]),s._v(" 步骤 1：在 A 上绑定 B 的 IP（需要 root 权限）")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" addr "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.2")]),s._v(".3.4 dev eth0\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("hr"),s._v(" "),t("h3",{attrs:{id:"步骤-2-配置-nginx-转发"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#步骤-2-配置-nginx-转发"}},[s._v("#")]),s._v(" 步骤 2：配置 Nginx 转发")]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("http")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("listen")]),s._v(" 1.2.3.4:80")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" /")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_pass")]),s._v(" http://5.6.7.8")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_set_header")]),s._v(" Host "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$host")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_set_header")]),s._v(" X-Real-IP "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$remote_addr")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("hr"),s._v(" "),t("h2",{attrs:{id:"✅-整体流程图-带-nginx"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#✅-整体流程图-带-nginx"}},[s._v("#")]),s._v(" ✅ 整体流程图（带 Nginx）：")]),s._v(" "),t("div",{staticClass:"language-plaintext line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-plaintext"}},[t("code",[s._v("客户端（请求 1.2.3.4） → A（Nginx） → 转发请求到 5.6.7.8\n                                   ← 响应\n← 客户端收到响应（仍然以为来自 1.2.3.4）\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("hr"),s._v(" "),t("h2",{attrs:{id:"🔁-总结对比"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#🔁-总结对比"}},[s._v("#")]),s._v(" 🔁 总结对比")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("实现方式")]),s._v(" "),t("th",[s._v("能否透明拦截")]),s._v(" "),t("th",[s._v("是否修改内核")]),s._v(" "),t("th",[s._v("优势")]),s._v(" "),t("th",[s._v("适用场景")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[t("code",[s._v("iptables + DNAT")])]),s._v(" "),t("td",[s._v("✅ 是")]),s._v(" "),t("td",[s._v("❗ 是")]),s._v(" "),t("td",[s._v("透明接管所有请求")]),s._v(" "),t("td",[t("strong",[s._v("系统级接管（推荐）")])])]),s._v(" "),t("tr",[t("td",[t("code",[s._v("nginx 反向代理")])]),s._v(" "),t("td",[s._v("❌ 否")]),s._v(" "),t("td",[s._v("❌ 否")]),s._v(" "),t("td",[s._v("配置简单，HTTP 支持强")]),s._v(" "),t("td",[s._v("主动使用 nginx 作为代理时")])]),s._v(" "),t("tr",[t("td",[t("code",[s._v("TProxy")]),s._v(" / "),t("code",[s._v("redsocks")])]),s._v(" "),t("td",[s._v("✅ 是")]),s._v(" "),t("td",[s._v("❗ 是")]),s._v(" "),t("td",[s._v("TCP/UDP 全面接管")]),s._v(" "),t("td",[s._v("高级网络接管需求")])])])]),s._v(" "),t("hr"),s._v(" "),t("p",[s._v("如果你希望将 "),t("strong",[s._v("本机上任意程序访问 1.2.3.4 的请求，全部自动走 C")]),s._v("，"),t("strong",[s._v("必须用 "),t("code",[s._v("iptables")]),s._v(" 转发")]),s._v("。\n但如果你能控制请求的源头，让它走 Nginx，就可以用反代。")]),s._v(" "),t("p",[s._v("你更倾向于哪种？是否我来帮你写完整的方案脚本？")])])}),[],!1,null,null,null);t.default=e.exports}}]);