(window.webpackJsonp=window.webpackJsonp||[]).push([[59],{416:function(s,r,t){"use strict";t.r(r);var a=t(7),v=Object(a.a)({},(function(){var s=this,r=s._self._c;return r("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[r("p",[s._v("在 Redis 集群（Redis Cluster）中，数据存储的具体主节点由 "),r("strong",[s._v("哈希槽（Hash Slot）分配机制")]),s._v(" 决定。其核心流程如下：")]),s._v(" "),r("hr"),s._v(" "),r("h3",{attrs:{id:"🔑-1-键值映射到哈希槽"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#🔑-1-键值映射到哈希槽"}},[s._v("#")]),s._v(" 🔑 "),r("strong",[s._v("1. 键值映射到哈希槽")])]),s._v(" "),r("p",[s._v("Redis 集群预设了 "),r("strong",[s._v("16384 个哈希槽")]),s._v("（Slot），每个键（Key）通过以下公式计算所属槽位：")]),s._v(" "),r("div",{staticClass:"language-plaintext line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-plaintext"}},[r("code",[s._v("Slot = CRC16(key) % 16384\n")])]),s._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[s._v("1")]),r("br")])]),r("ul",[r("li",[r("strong",[s._v("CRC16算法")]),s._v("：计算键的哈希值（16位整数）。")]),s._v(" "),r("li",[r("strong",[s._v("取模运算")]),s._v("：将哈希值对 "),r("code",[s._v("16384")]),s._v(" 取余，得到槽位编号（0~16383）。")])]),s._v(" "),r("blockquote",[r("p",[r("strong",[s._v("示例")]),s._v("："),r("br"),s._v("\n若键为 "),r("code",[s._v("user:1001")]),s._v("，计算 "),r("code",[s._v('CRC16("user:1001") = 12345')]),s._v("，则 "),r("code",[s._v("Slot = 12345 % 16384 = 12345")]),s._v("。")])]),s._v(" "),r("hr"),s._v(" "),r("h3",{attrs:{id:"⚙️-2-槽位分配到主节点"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#⚙️-2-槽位分配到主节点"}},[s._v("#")]),s._v(" ⚙️ "),r("strong",[s._v("2. 槽位分配到主节点")])]),s._v(" "),r("p",[s._v("集群初始化时，16384 个槽会被"),r("strong",[s._v("平均分配")]),s._v("给所有主节点：")]),s._v(" "),r("ul",[r("li",[r("strong",[s._v("分配原则")]),s._v("：每个主节点负责一段连续的槽范围（如 Node1 负责 0~5460，Node2 负责 5461~10922 等）。")]),s._v(" "),r("li",[r("strong",[s._v("动态调整")]),s._v("：扩容或缩容时，槽位可通过命令迁移到新节点（如 "),r("code",[s._v("CLUSTER ADDSLOTS")]),s._v("、"),r("code",[s._v("CLUSTER SETSLOT")]),s._v("）。")])]),s._v(" "),r("blockquote",[r("p",[r("strong",[s._v("关键特性")]),s._v("："),r("br"),s._v("\n槽位与节点的映射关系由集群内部维护，客户端无需硬编码节点信息。")])]),s._v(" "),r("hr"),s._v(" "),r("h3",{attrs:{id:"📡-3-客户端请求路由流程"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#📡-3-客户端请求路由流程"}},[s._v("#")]),s._v(" 📡 "),r("strong",[s._v("3. 客户端请求路由流程")])]),s._v(" "),r("p",[s._v("客户端访问数据时，按以下逻辑定位目标节点：")]),s._v(" "),r("ol",[r("li",[r("strong",[s._v("本地缓存查询")]),s._v("："),r("br"),s._v("\n客户端（如 JedisCluster）缓存了槽位与节点的映射表。"),r("br"),s._v("\n根据键计算槽位，直接请求对应节点。")]),s._v(" "),r("li",[r("strong",[s._v("节点重定向")]),s._v("：\n"),r("ul",[r("li",[s._v("若请求的节点"),r("strong",[s._v("不负责该槽")]),s._v("，返回 "),r("code",[s._v("MOVED")]),s._v(" 错误（含正确节点地址），客户端更新缓存并重试。")]),s._v(" "),r("li",[s._v("若槽位"),r("strong",[s._v("正在迁移")]),s._v("中，返回 "),r("code",[s._v("ASK")]),s._v(" 临时重定向，客户端需向目标节点发送 "),r("code",[s._v("ASKING")]),s._v(" 命令后再执行操作。")])])])]),s._v(" "),r("hr"),s._v(" "),r("h3",{attrs:{id:"🔄-4-节点变化时的处理"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#🔄-4-节点变化时的处理"}},[s._v("#")]),s._v(" 🔄 "),r("strong",[s._v("4. 节点变化时的处理")])]),s._v(" "),r("ul",[r("li",[r("strong",[s._v("扩容/缩容")]),s._v("："),r("br"),s._v("\n槽位迁移期间，集群通过 "),r("code",[s._v("MOVED")]),s._v("/"),r("code",[s._v("ASK")]),s._v(" 机制保证请求正确路由，客户端自动感知新拓扑。")]),s._v(" "),r("li",[r("strong",[s._v("主节点故障")]),s._v("："),r("br"),s._v("\n从节点接替槽位后，集群通过 Gossip 协议同步新映射关系，客户端通过重定向更新缓存。")])]),s._v(" "),r("hr"),s._v(" "),r("h3",{attrs:{id:"💡-为何是-16384-个槽"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#💡-为何是-16384-个槽"}},[s._v("#")]),s._v(" 💡 "),r("strong",[s._v("为何是 16384 个槽？")])]),s._v(" "),r("ul",[r("li",[r("strong",[s._v("消息效率")]),s._v("：集群心跳包需携带槽位分配信息，"),r("code",[s._v("16384")]),s._v(" 仅需 2KB 空间，而 "),r("code",[s._v("65536")]),s._v(" 需 8KB，更节省网络带宽。")]),s._v(" "),r("li",[r("strong",[s._v("分布均衡")]),s._v("：足够多的槽数确保数据均匀分布，避免热点问题。")])]),s._v(" "),r("hr"),s._v(" "),r("h3",{attrs:{id:"⚠️-注意事项"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#⚠️-注意事项"}},[s._v("#")]),s._v(" ⚠️ "),r("strong",[s._v("注意事项")])]),s._v(" "),r("ol",[r("li",[r("strong",[s._v("键哈希优化")]),s._v("："),r("br"),s._v("\n使用哈希标签（如 "),r("code",[s._v("user:{1001}:profile")]),s._v("）可强制多个键映射到同一槽位，支持事务操作。")]),s._v(" "),r("li",[r("strong",[s._v("客户端要求")]),s._v("："),r("br"),s._v("\n需支持智能路由（如 JedisCluster、Lettuce），避免频繁重定向降低性能。")]),s._v(" "),r("li",[r("strong",[s._v("集群状态")]),s._v("："),r("br"),s._v("\n若槽位未完全分配（如节点宕机），集群可能拒绝请求，需配置 "),r("code",[s._v("cluster-require-full-coverage=no")]),s._v(" 避免全局不可用。")])]),s._v(" "),r("hr"),s._v(" "),r("h3",{attrs:{id:"✅-总结流程"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#✅-总结流程"}},[s._v("#")]),s._v(" ✅ "),r("strong",[s._v("总结流程")])]),s._v(" "),r("div",{staticClass:"language-mermaid line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-mermaid"}},[r("code",[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("graph")]),s._v(" LR\nA"),r("span",{pre:!0,attrs:{class:"token text string"}},[s._v("[客户端写入 Key]")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" B[计算 CRC16"),r("span",{pre:!0,attrs:{class:"token text string"}},[s._v("(key)")]),s._v(" % 16384 得到 Slot]\nB "),r("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" C"),r("span",{pre:!0,attrs:{class:"token text string"}},[s._v("[查询本地槽位映射表]")]),s._v("\nC "),r("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" D"),r("span",{pre:!0,attrs:{class:"token text string"}},[s._v("{当前节点是否负责 Slot？}")]),s._v("\nD "),r("span",{pre:!0,attrs:{class:"token inter-arrow-label"}},[r("span",{pre:!0,attrs:{class:"token arrow-head arrow operator"}},[s._v("--")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token label property"}},[s._v("是")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")])]),s._v(" E"),r("span",{pre:!0,attrs:{class:"token text string"}},[s._v("[执行写入]")]),s._v("\nD "),r("span",{pre:!0,attrs:{class:"token inter-arrow-label"}},[r("span",{pre:!0,attrs:{class:"token arrow-head arrow operator"}},[s._v("--")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token label property"}},[s._v("否")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")])]),s._v(" F"),r("span",{pre:!0,attrs:{class:"token text string"}},[s._v("[返回 MOVED/ASK 重定向]")]),s._v("\nF "),r("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" G"),r("span",{pre:!0,attrs:{class:"token text string"}},[s._v("[客户端更新映射表并重试]")]),s._v("\n")])]),s._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[s._v("1")]),r("br"),r("span",{staticClass:"line-number"},[s._v("2")]),r("br"),r("span",{staticClass:"line-number"},[s._v("3")]),r("br"),r("span",{staticClass:"line-number"},[s._v("4")]),r("br"),r("span",{staticClass:"line-number"},[s._v("5")]),r("br"),r("span",{staticClass:"line-number"},[s._v("6")]),r("br"),r("span",{staticClass:"line-number"},[s._v("7")]),r("br")])]),r("p",[s._v("通过哈希槽机制，Redis 集群实现了数据分片、动态扩缩容和故障转移的自动化，开发者只需关注业务逻辑，无需手动管理数据分布。")])])}),[],!1,null,null,null);r.default=v.exports}}]);