(window.webpackJsonp=window.webpackJsonp||[]).push([[204],{561:function(a,s,t){"use strict";t.r(s);var e=t(7),r=Object(e.a)({},(function(){var a=this,s=a._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("p",[a._v("你现在的目标是：")]),a._v(" "),s("hr"),a._v(" "),s("h2",{attrs:{id:"🎯-目标说明"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#🎯-目标说明"}},[a._v("#")]),a._v(" 🎯 目标说明")]),a._v(" "),s("p",[a._v("在主机 "),s("strong",[a._v("A（192.168.2.53）")]),a._v(" 上，有一个应用发起 TCP 请求到：")]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("目标地址：115.236.18.198:11111（公网 IP，其实已经不可用）\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("p",[a._v("你想让：")]),a._v(" "),s("ul",[s("li",[a._v("这个请求实际上被透明地"),s("strong",[a._v("重定向到内网主机 C（192.168.2.10）")])]),a._v(" "),s("li",[a._v("C 能够完整接收到请求，正常建立 TCP 连接，并响应")])]),a._v(" "),s("hr"),a._v(" "),s("h2",{attrs:{id:"✅-实现方式-使用-iptables-内核转发-nat"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#✅-实现方式-使用-iptables-内核转发-nat"}},[a._v("#")]),a._v(" ✅ 实现方式：使用 "),s("code",[a._v("iptables")]),a._v(" + 内核转发 + NAT")]),a._v(" "),s("p",[a._v("这是一个典型的 "),s("strong",[a._v("透明 TCP 代理/重定向")]),a._v(" 场景，使用 "),s("code",[a._v("iptables")]),a._v(" 做 "),s("strong",[a._v("DNAT")]),a._v("（目的地址转换），将请求从公网 IP 转发到内网 IP。")]),a._v(" "),s("hr"),a._v(" "),s("h2",{attrs:{id:"🛠️-操作步骤-在主机-a-上执行"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#🛠️-操作步骤-在主机-a-上执行"}},[a._v("#")]),a._v(" 🛠️ 操作步骤（在主机 A 上执行）")]),a._v(" "),s("h3",{attrs:{id:"_1️⃣-开启内核-ip-转发"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1️⃣-开启内核-ip-转发"}},[a._v("#")]),a._v(" 1️⃣ 开启内核 IP 转发")]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sysctl")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-w")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("net.ipv4.ip_forward")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("blockquote",[s("p",[a._v("临时生效。想永久生效，编辑 "),s("code",[a._v("/etc/sysctl.conf")]),a._v(" 加入：")]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("net.ipv4.ip_forward "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])])]),a._v(" "),s("hr"),a._v(" "),s("h3",{attrs:{id:"_2️⃣-添加-dnat-转发规则-将请求-115-236-18-198-转到-c"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2️⃣-添加-dnat-转发规则-将请求-115-236-18-198-转到-c"}},[a._v("#")]),a._v(" 2️⃣ 添加 DNAT 转发规则（将请求 115.236.18.198 转到 C）")]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" iptables "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-t")]),a._v(" nat "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-A")]),a._v(" OUTPUT "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" tcp "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("115.236")]),a._v(".18.198 "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--dport")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("11111")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-j")]),a._v(" DNAT --to-destination "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".2.10:11111\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("p",[a._v("说明：")]),a._v(" "),s("ul",[s("li",[s("code",[a._v("OUTPUT")]),a._v(" 链适用于本机发出的连接（你的应用就在 A 上）")]),a._v(" "),s("li",[a._v("所有目标为公网 IP "),s("code",[a._v("115.236.18.198")]),a._v(" 的请求将被改写为 "),s("code",[a._v("192.168.2.10")])])]),a._v(" "),s("hr"),a._v(" "),s("h3",{attrs:{id:"_3️⃣-设置-snat-可选-一般不需要"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3️⃣-设置-snat-可选-一般不需要"}},[a._v("#")]),a._v(" 3️⃣ 设置 SNAT（可选，一般不需要）")]),a._v(" "),s("p",[a._v("如果你发现 "),s("strong",[a._v("C 无法正常响应请求")]),a._v("，可添加这条 SNAT（伪装源 IP 为 A）：")]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" iptables "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-t")]),a._v(" nat "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-A")]),a._v(" POSTROUTING "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" tcp "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".2.10 "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--dport")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("11111")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-j")]),a._v(" MASQUERADE\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("hr"),a._v(" "),s("h2",{attrs:{id:"✅-整体流程说明"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#✅-整体流程说明"}},[a._v("#")]),a._v(" ✅ 整体流程说明：")]),a._v(" "),s("table",[s("thead",[s("tr",[s("th",[a._v("步骤")]),a._v(" "),s("th",[a._v("数据包")]),a._v(" "),s("th",[a._v("说明")])])]),a._v(" "),s("tbody",[s("tr",[s("td",[a._v("应用发起连接")]),a._v(" "),s("td",[a._v("源：192.168.2.53"),s("br"),a._v("目标：115.236.18.198:11111")]),a._v(" "),s("td",[a._v("应用仍然以为在访问公网")])]),a._v(" "),s("tr",[s("td",[a._v("iptables（OUTPUT 链）重写")]),a._v(" "),s("td",[a._v("修改目标地址 → 192.168.2.10")]),a._v(" "),s("td",[a._v("实际连接转向 C")])]),a._v(" "),s("tr",[s("td",[a._v("建立连接")]),a._v(" "),s("td",[a._v("A ↔ C 完成三次握手")]),a._v(" "),s("td")]),a._v(" "),s("tr",[s("td",[a._v("C 回复响应")]),a._v(" "),s("td",[a._v("源地址为 C，目标仍是 A")]),a._v(" "),s("td")]),a._v(" "),s("tr",[s("td",[a._v("应用收到响应")]),a._v(" "),s("td",[a._v("应用以为来自公网 IP，但其实是 C")]),a._v(" "),s("td")])])]),a._v(" "),s("hr"),a._v(" "),s("h2",{attrs:{id:"🧪-测试建议"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#🧪-测试建议"}},[a._v("#")]),a._v(" 🧪 测试建议")]),a._v(" "),s("ol",[s("li",[a._v("在 C 上运行监听服务：")])]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("nc")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-l")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("11111")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("ol",{attrs:{start:"2"}},[s("li",[a._v("在 A 上用你原本的程序发起请求，或使用：")])]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("telnet "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("115.236")]),a._v(".18.198 "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("11111")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 或")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("curl")]),a._v(" http://115.236.18.198:11111\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br")])]),s("ol",{attrs:{start:"3"}},[s("li",[a._v("C 上应该能看到连接建立。")])]),a._v(" "),s("hr"),a._v(" "),s("h2",{attrs:{id:"🔁-如果想让其他主机的请求也被转发怎么办"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#🔁-如果想让其他主机的请求也被转发怎么办"}},[a._v("#")]),a._v(" 🔁 如果想让"),s("strong",[a._v("其他主机的请求也被转发")]),a._v("怎么办？")]),a._v(" "),s("p",[a._v("你需要改用：")]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("iptables "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-t")]),a._v(" nat "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-A")]),a._v(" PREROUTING "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" tcp "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("115.236")]),a._v(".18.198 "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--dport")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("11111")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-j")]),a._v(" DNAT --to-destination "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".2.10:11111\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("p",[a._v("但这要求：")]),a._v(" "),s("ul",[s("li",[s("strong",[a._v("A 是这些主机的网关")])]),a._v(" "),s("li",[a._v("或者你将这些主机的流量强制经过 A（静态路由或网桥）")])]),a._v(" "),s("hr"),a._v(" "),s("h2",{attrs:{id:"✅-总结方案-你的场景"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#✅-总结方案-你的场景"}},[a._v("#")]),a._v(" ✅ 总结方案（你的场景）")]),a._v(" "),s("p",[a._v("在主机 A 上执行以下命令即可：")]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 1. 启用 IP 转发")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("tee")]),a._v(" /proc/sys/net/ipv4/ip_forward\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 2. NAT 规则 - 本地应用发出的请求")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" iptables "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-t")]),a._v(" nat "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-A")]),a._v(" OUTPUT "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" tcp "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("115.236")]),a._v(".18.198 "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--dport")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("11111")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-j")]),a._v(" DNAT --to-destination "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".2.10:11111\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br")])]),s("p",[a._v("这会让本机所有访问 "),s("code",[a._v("115.236.18.198:11111")]),a._v(" 的 TCP 请求都发给 "),s("code",[a._v("192.168.2.10:11111")]),a._v("，完全透明。")]),a._v(" "),s("hr")])}),[],!1,null,null,null);s.default=r.exports}}]);